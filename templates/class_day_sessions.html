{% extends "base.html" %}

{% block title %}{{ class_room.name }} - {{ day_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">الطوابق</a> / 
        <a href="{{ url_for('floor_detail', floor_id=class_room.floor_id) }}">{{ class_room.floor.name }}</a> / 
        <a href="{{ url_for('class_detail', class_id=class_room.id) }}">{{ class_room.name }}</a> / 
        <span>{{ day_name }}</span>
    </div>
    <div class="header-content">
        <div>
            <h2>حصص {{ day_name }}</h2>
            <p class="subtitle">{{ class_room.name }} - {{ class_room.floor.name }}</p>
            {% if is_today %}
            <div class="today-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                اليوم - الوقت الحالي: {{ current_time.strftime('%H:%M') }}
            </div>
            {% endif %}
        </div>
        <div class="header-actions">
            <a href="{{ url_for('class_schedules', class_id=class_room.id) }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                تعديل الجدول
            </a>
            <a href="{{ url_for('admin_teachers') }}" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                إدارة المعلمين
            </a>
        </div>
    </div>
</div>

<div class="sessions-container">
    {% for schedule in day_schedules %}
    {% set attendance = attendance_records.get(schedule.id) %}
    {% set is_current = (schedule.id == current_session_id) %}
    {% set can_mark = is_today and is_current and not attendance %}
    
    <div class="session-card {% if is_current %}current-session{% endif %} {% if attendance %}marked{% endif %}">
        <div class="session-time">
            <div class="time-badge {% if is_current %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/>
                </svg>
                <span>{{ schedule.start_time.strftime('%H:%M') }} - {{ schedule.end_time.strftime('%H:%M') }}</span>
            </div>
            {% if is_current %}
            <span class="current-badge">الحصة الحالية</span>
            {% endif %}
        </div>
        
        <div class="session-details">
            <div class="session-info">
                <div class="session-title-row">
                    <div>
                        <h3>{{ schedule.subject.name }}</h3>
                        <p class="teacher-name">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            {{ schedule.teacher.name }}
                        </p>
                    </div>
                    <div class="session-actions">
                        <a href="{{ url_for('edit_schedule', schedule_id=schedule.id) }}" class="btn-icon" title="تعديل الحصة">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </a>
                        <form method="POST" action="{{ url_for('delete_schedule', schedule_id=schedule.id) }}" style="display: inline;" onsubmit="return confirm('هل أنت متأكد من حذف هذه الحصة؟');">
                            <button type="submit" class="btn-icon btn-icon-danger" title="حذف الحصة">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            {% if attendance %}
            <!-- Attendance already marked -->
            <div class="attendance-status marked-status status-{{ attendance.status.lower() }}">
                <div class="status-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    <span>تم التسجيل</span>
                </div>
                <div class="status-details">
                    <p><strong>الحالة:</strong> 
                        {% if attendance.status == 'Present' %}
                        <span class="status-label status-present">حاضر</span>
                        {% elif attendance.status == 'Late' %}
                        <span class="status-label status-late">متأخر ({{ attendance.minutes_late }} دقيقة)</span>
                        {% elif attendance.status == 'Absent' %}
                        <span class="status-label status-absent">غائب</span>
                        {% endif %}
                    </p>
                    {% if attendance.notes %}
                    <p><strong>ملاحظات:</strong> {{ attendance.notes }}</p>
                    {% endif %}
                </div>
            </div>
            
            {% elif can_mark %}
            <!-- Can mark attendance now -->
            <div class="attendance-form">
                <h4>تسجيل الحضور</h4>
                <form action="{{ url_for('mark_attendance', schedule_id=schedule.id) }}" method="POST">
                    <div class="status-options">
                        <label class="status-option">
                            <input type="radio" name="status" value="Present" required>
                            <span class="option-content present">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                                حاضر
                            </span>
                        </label>
                        
                        <label class="status-option">
                            <input type="radio" name="status" value="Late" required>
                            <span class="option-content late">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/>
                                </svg>
                                متأخر
                            </span>
                        </label>
                        
                        <label class="status-option">
                            <input type="radio" name="status" value="Absent" required>
                            <span class="option-content absent">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                                غائب
                            </span>
                        </label>
                    </div>
                    
                    <div class="late-time-input" style="display: none;">
                        <label>وقت الوصول الفعلي:</label>
                        <input type="time" name="actual_time" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات (اختياري):</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="أضف ملاحظات إن وجدت..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-save">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                        </svg>
                        حفظ الحضور
                    </button>
                </form>
            </div>
            
            {% elif is_today and not is_current %}
            <!-- It's today but not the current session -->
            <div class="attendance-info">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p>يمكن تسجيل الحضور فقط خلال وقت الحصة</p>
            </div>
            
            {% else %}
            <!-- Not today -->
            <div class="attendance-info">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                </svg>
                <p>يمكن تسجيل الحضور في يوم الحصة فقط</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% if not day_schedules %}
<div class="empty-state">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="64" height="64">
        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
    </svg>
    <h3>لا توجد حصص</h3>
    <p>لا توجد حصص مسجلة لهذا اليوم</p>
</div>
{% endif %}

<div class="back-button-container">
    <a href="{{ url_for('class_detail', class_id=class_room.id) }}" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        رجوع إلى الأيام
    </a>
</div>

<script>
// Show/hide late time input based on status selection
document.querySelectorAll('input[name="status"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        var lateTimeInput = this.closest('form').querySelector('.late-time-input');
        if (this.value === 'Late') {
            lateTimeInput.style.display = 'block';
            lateTimeInput.querySelector('input').required = true;
        } else {
            lateTimeInput.style.display = 'none';
            lateTimeInput.querySelector('input').required = false;
        }
    });
});
</script>

<style>
.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    flex-wrap: wrap;
}

.header-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.header-actions .btn {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.today-indicator {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    margin-top: 15px;
}

.sessions-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 30px 0;
}

.session-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.session-card.current-session {
    border: 2px solid #28a745;
    box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
}

.session-card.marked {
    opacity: 0.85;
}

.session-time {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.session-card.current-session .session-time {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.time-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    color: white;
    font-weight: 600;
    font-size: 1.1em;
}

.current-badge {
    background: rgba(255, 255, 255, 0.3);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    color: white;
}

.session-details {
    padding: 20px;
}

.session-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
}

.session-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: #f0f0f0;
    color: #667eea;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.btn-icon-danger {
    color: #dc3545;
}

.btn-icon-danger:hover {
    background: #dc3545;
    color: white;
}

.session-info h3 {
    color: #333;
    margin-bottom: 10px;
    font-size: 1.3em;
}

.teacher-name {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 1em;
}

.attendance-form {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #f0f0f0;
}

.attendance-form h4 {
    color: #333;
    margin-bottom: 15px;
}

.status-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.status-option {
    cursor: pointer;
}

.status-option input[type="radio"] {
    display: none;
}

.option-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.option-content:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.status-option input:checked + .option-content {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    font-weight: 600;
}

.option-content.present svg { color: #28a745; }
.option-content.late svg { color: #ffc107; }
.option-content.absent svg { color: #dc3545; }

.late-time-input {
    margin-bottom: 15px;
}

.late-time-input label {
    display: block;
    margin-bottom: 5px;
    color: #555;
    font-weight: 600;
}

.btn-save {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.attendance-status {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.status-header {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #28a745;
    font-weight: 600;
    margin-bottom: 10px;
}

.status-label {
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
}

.status-present {
    background: #28a745;
    color: white;
}

.status-late {
    background: #ffc107;
    color: #333;
}

.status-absent {
    background: #dc3545;
    color: white;
}

.attendance-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #666;
}

.attendance-info svg {
    color: #999;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.empty-state svg {
    color: #ccc;
    margin-bottom: 20px;
}

.back-button-container {
    margin-top: 30px;
    text-align: center;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
    }
    
    .header-actions {
        width: 100%;
    }
    
    .header-actions .btn {
        flex: 1;
        justify-content: center;
    }
    
    .status-options {
        grid-template-columns: 1fr;
    }
    
    .session-title-row {
        flex-direction: column;
    }
    
    .session-actions {
        align-self: flex-end;
    }
}
</style>
{% endblock %}

